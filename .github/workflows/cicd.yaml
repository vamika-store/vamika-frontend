name: VM-FRONTEND

on: 
    push:
        branches:
            - main
jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
            
            - name: Setup Node
              uses: actions/setup-node@v3
              with:
                node-versions: '20.x'
            - name: Install Dependencies
              working-directory: .
              run: npm ci
              
    Docker-Build_and_Push:
        runs-on: ubuntu-latest
        needs:
            - build
        env:
            IMAGE_NAME: "vamika-frontend:v0.0.1"
            BUILDER_IMAGE: "node:22.12"
        steps:
            - name: Checkout code
              uses: actions/checkout@v2
            - name: Docker Login
              run: |
                echo "${{ secrets.IMAGE_REGISTRY_TOKEN }}" | docker login -u ${{ secrets.IMAGE_REGISTRY_USERNAME }} --password-stdin
            - name: Docker Build
              run: |
                COMMIT_AUTHOR=$(git log -1 --pretty=%an)
                COMMIT_ID=$(git rev-parse --short "$GITHUB_SHA")
                docker build \
                  --build-arg BUILDER_IMAGE="${{ env.BUILDER_IMAGE }}" \
                  --label AUTHOR="${COMMIT_AUTHOR}" \
                  --label COMMIT_ID="${COMMIT_ID}" \
                  -t "${{ secrets.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}" .
            - name: Push Docker image
              run: |
                docker push ${{ secrets.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}
            - name: Docker Logout
              run: |
                docker logout ${{ secrets.IMAGE_REGISTRY }}

  
 


